# 卡密使用逻辑改进建议

## 📋 当前逻辑分析

### 现状（CardKeyService::use 方法）

```php
public function use(string $cardKey, int $userId, array $extra = []): array
{
    try {
        // 1. 验证卡密（状态、过期等）
        $verifyResult = CardKeyUtil::verify($cardKey);
        if (!$verifyResult['success']) {
            return $verifyResult;
        }

        $cardKeyModel = $verifyResult['data'];
        
        // 2. 更新为已使用状态
        $cardKeyModel->status = CardKey::STATUS_USED;
        $cardKeyModel->user_id = $userId;
        $cardKeyModel->use_time = date('Y-m-d H:i:s');
        $cardKeyModel->save();
        
        // 3. 记录使用日志
        CardKeyLog::create([...]);
        
        return [
            'success' => true,
            'message' => '使用成功',
            'data' => $cardKeyModel
        ];
    } catch (\Exception $e) {
        return [
            'success' => false,
            'message' => '使用失败：' . $e->getMessage()
        ];
    }
}
```

### ❌ 当前问题

1. **没有根据卡密类型处理业务逻辑**
   - 不同类型的卡密应该有不同的效果
   - 目前只是简单标记为"已使用"

2. **没有给用户增加会员时长**
   - `cardType.membership_duration` 字段未使用
   - 没有计算和更新用户的会员到期时间

3. **没有区分卡密类型的业务含义**
   - VIP 兑换码：应该增加会员时长
   - 商品兑换码：应该发放商品/积分
   - 优惠券：应该生成优惠券记录
   - 体验卡：应该设置临时权限

---

## ✅ 改进建议

### 方案 1：根据会员时长处理（推荐）

适用于所有卡密都是给用户增加会员时长的场景。

```php
public function use(string $cardKey, int $userId, array $extra = []): array
{
    try {
        // 1. 验证卡密
        $verifyResult = CardKeyUtil::verify($cardKey);
        if (!$verifyResult['success']) {
            return $verifyResult;
        }

        $cardKeyModel = $verifyResult['data'];
        $cardType = $cardKeyModel->cardType;
        
        // 2. 更新为已使用状态
        $cardKeyModel->status = CardKey::STATUS_USED;
        $cardKeyModel->user_id = $userId;
        $cardKeyModel->use_time = date('Y-m-d H:i:s');
        $cardKeyModel->save();
        
        // 3. 处理会员时长逻辑
        if ($cardType && isset($cardType->membership_duration)) {
            $this->processUserMembership($userId, $cardType->membership_duration);
        }
        
        // 4. 记录使用日志
        CardKeyLog::create([
            'card_key_id' => $cardKeyModel->id,
            'user_id' => $userId,
            'action' => 'use',
            'ip' => $extra['ip'] ?? '',
            'user_agent' => $extra['user_agent'] ?? '',
            'remark' => $extra['remark'] ?? '',
            'create_time' => date('Y-m-d H:i:s')
        ]);
        
        return [
            'success' => true,
            'message' => '使用成功',
            'data' => [
                'card_key' => $cardKeyModel,
                'membership_info' => $this->getUserMembershipInfo($userId)
            ]
        ];
    } catch (\Exception $e) {
        return [
            'success' => false,
            'message' => '使用失败：' . $e->getMessage()
        ];
    }
}

/**
 * 处理用户会员时长
 * 
 * @param int $userId 用户ID
 * @param int $durationMinutes 会员时长（分钟）
 */
private function processUserMembership(int $userId, int $durationMinutes): void
{
    // 获取用户模型
    $user = User::find($userId);
    if (!$user) {
        throw new \Exception('用户不存在');
    }
    
    // 0 = 永久会员
    if ($durationMinutes === 0) {
        $user->vip_expire_time = null; // null 表示永久
        $user->is_vip = 1;
    } else {
        // 计算到期时间
        $currentExpireTime = $user->vip_expire_time;
        
        if ($currentExpireTime && strtotime($currentExpireTime) > time()) {
            // 如果当前会员未过期，在现有时间基础上累加
            $newExpireTime = date('Y-m-d H:i:s', strtotime($currentExpireTime) + ($durationMinutes * 60));
        } else {
            // 如果当前会员已过期或没有会员，从现在开始计算
            $newExpireTime = date('Y-m-d H:i:s', time() + ($durationMinutes * 60));
        }
        
        $user->vip_expire_time = $newExpireTime;
        $user->is_vip = 1;
    }
    
    $user->save();
}

/**
 * 获取用户会员信息
 */
private function getUserMembershipInfo(int $userId): array
{
    $user = User::find($userId);
    if (!$user) {
        return [];
    }
    
    return [
        'is_vip' => $user->is_vip,
        'vip_expire_time' => $user->vip_expire_time,
        'is_permanent' => $user->vip_expire_time === null && $user->is_vip
    ];
}
```

---

### 方案 2：根据类型代码区分业务逻辑

适用于卡密类型有不同业务含义的场景。

```php
public function use(string $cardKey, int $userId, array $extra = []): array
{
    try {
        $verifyResult = CardKeyUtil::verify($cardKey);
        if (!$verifyResult['success']) {
            return $verifyResult;
        }

        $cardKeyModel = $verifyResult['data'];
        $cardType = $cardKeyModel->cardType;
        
        // 更新为已使用状态
        $cardKeyModel->status = CardKey::STATUS_USED;
        $cardKeyModel->user_id = $userId;
        $cardKeyModel->use_time = date('Y-m-d H:i:s');
        $cardKeyModel->save();
        
        // 根据类型代码处理不同业务逻辑
        $result = $this->processByCardType($userId, $cardType);
        
        // 记录使用日志
        CardKeyLog::create([...]);
        
        return [
            'success' => true,
            'message' => '使用成功',
            'data' => [
                'card_key' => $cardKeyModel,
                'result' => $result
            ]
        ];
    } catch (\Exception $e) {
        return [...];
    }
}

/**
 * 根据卡密类型处理业务逻辑
 */
private function processByCardType(int $userId, $cardType): array
{
    if (!$cardType) {
        return [];
    }
    
    switch ($cardType->type_code) {
        case 'VIP_CARD':
            // VIP 兑换码：增加会员时长
            return $this->processVipCard($userId, $cardType);
            
        case 'PRODUCT_CARD':
            // 商品兑换码：发放商品或积分
            return $this->processProductCard($userId, $cardType);
            
        case 'COUPON_CARD':
            // 优惠券：生成优惠券记录
            return $this->processCouponCard($userId, $cardType);
            
        case 'TRIAL_CARD':
            // 体验卡：设置临时权限
            return $this->processTrialCard($userId, $cardType);
            
        default:
            // 默认：增加会员时长
            return $this->processVipCard($userId, $cardType);
    }
}

/**
 * 处理 VIP 兑换码
 */
private function processVipCard(int $userId, $cardType): array
{
    $this->processUserMembership($userId, $cardType->membership_duration);
    return $this->getUserMembershipInfo($userId);
}

/**
 * 处理商品兑换码
 */
private function processProductCard(int $userId, $cardType): array
{
    // 发放商品、积分等
    // TODO: 实现具体逻辑
    return ['type' => 'product', 'processed' => true];
}

/**
 * 处理优惠券
 */
private function processCouponCard(int $userId, $cardType): array
{
    // 生成优惠券记录
    // TODO: 实现具体逻辑
    return ['type' => 'coupon', 'processed' => true];
}

/**
 * 处理体验卡
 */
private function processTrialCard(int $userId, $cardType): array
{
    // 设置临时体验权限
    // TODO: 实现具体逻辑
    return ['type' => 'trial', 'processed' => true];
}
```

---

## 🗄️ 数据库字段建议

### 用户表（users）需要的字段

```sql
ALTER TABLE `users` ADD COLUMN `is_vip` TINYINT(1) DEFAULT 0 COMMENT '是否是VIP会员 0=否 1=是';
ALTER TABLE `users` ADD COLUMN `vip_expire_time` DATETIME NULL COMMENT 'VIP到期时间 NULL=永久会员';
ALTER TABLE `users` ADD COLUMN `vip_level` INT DEFAULT 1 COMMENT 'VIP等级';
```

### 卡密类型表（card_types）已有字段

```sql
-- 已有字段
membership_duration INT NULL COMMENT '会员时长（分钟） 0=永久 NULL=无时长'
available_days INT NULL COMMENT '可用天数 NULL=永久可用'
```

---

## 📊 使用流程图

```
用户使用卡密
    ↓
验证卡密（状态、过期等）
    ↓
获取卡密类型信息
    ↓
根据类型处理业务逻辑
    ├─ VIP卡：增加会员时长
    ├─ 商品卡：发放商品/积分
    ├─ 优惠券：生成优惠券
    └─ 体验卡：临时权限
    ↓
更新卡密状态为已使用
    ↓
记录使用日志
    ↓
返回处理结果
```

---

## 🎯 推荐实现步骤

1. **第一步**：实现方案1（会员时长处理）
   - 添加用户表字段
   - 实现 `processUserMembership` 方法
   - 测试会员时长累加逻辑

2. **第二步**（可选）：扩展方案2（多类型支持）
   - 定义类型代码常量
   - 实现各类型的处理方法
   - 根据业务需求逐步完善

3. **第三步**：完善日志记录
   - 记录会员变更前后的状态
   - 记录具体的业务处理结果

---

## 💡 注意事项

1. **事务处理**：使用数据库事务确保数据一致性
2. **并发控制**：防止同一张卡密被重复使用
3. **异常处理**：失败时回滚所有操作
4. **日志完整性**：记录详细的操作信息便于追溯

---

## 📝 示例：完整的事务实现

```php
use think\facade\Db;

public function use(string $cardKey, int $userId, array $extra = []): array
{
    // 开启事务
    Db::startTrans();
    
    try {
        // 1. 验证卡密（加锁防止并发）
        $verifyResult = CardKeyUtil::verify($cardKey);
        if (!$verifyResult['success']) {
            Db::rollback();
            return $verifyResult;
        }

        $cardKeyModel = $verifyResult['data'];
        
        // 2. 再次检查状态（双重验证）
        if ($cardKeyModel->status !== CardKey::STATUS_UNUSED) {
            Db::rollback();
            return [
                'success' => false,
                'message' => '卡密已被使用或禁用'
            ];
        }
        
        // 3. 更新卡密状态
        $cardKeyModel->status = CardKey::STATUS_USED;
        $cardKeyModel->user_id = $userId;
        $cardKeyModel->use_time = date('Y-m-d H:i:s');
        $cardKeyModel->save();
        
        // 4. 处理业务逻辑
        $cardType = $cardKeyModel->cardType;
        if ($cardType && isset($cardType->membership_duration)) {
            $this->processUserMembership($userId, $cardType->membership_duration);
        }
        
        // 5. 记录日志
        CardKeyLog::create([...]);
        
        // 提交事务
        Db::commit();
        
        return [
            'success' => true,
            'message' => '使用成功',
            'data' => [
                'card_key' => $cardKeyModel,
                'membership_info' => $this->getUserMembershipInfo($userId)
            ]
        ];
        
    } catch (\Exception $e) {
        // 回滚事务
        Db::rollback();
        
        return [
            'success' => false,
            'message' => '使用失败：' . $e->getMessage()
        ];
    }
}
```

---

## 🔗 相关文件

- 后端 Service: `src/admin/m-service-server/app/api/services/CardKeyService.php`
- 后端 Controller: `src/admin/m-service-server/app/api/controller/v1/CardKey.php`
- 前端 API: `src/api/cardKey.ts`
- 前端组件: `src/views/basic/cardKey.vue`

