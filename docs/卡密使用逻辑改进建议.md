# å¡å¯†ä½¿ç”¨é€»è¾‘æ”¹è¿›å»ºè®®

## ğŸ“‹ å½“å‰é€»è¾‘åˆ†æ

### ç°çŠ¶ï¼ˆCardKeyService::use æ–¹æ³•ï¼‰

```php
public function use(string $cardKey, int $userId, array $extra = []): array
{
    try {
        // 1. éªŒè¯å¡å¯†ï¼ˆçŠ¶æ€ã€è¿‡æœŸç­‰ï¼‰
        $verifyResult = CardKeyUtil::verify($cardKey);
        if (!$verifyResult['success']) {
            return $verifyResult;
        }

        $cardKeyModel = $verifyResult['data'];
        
        // 2. æ›´æ–°ä¸ºå·²ä½¿ç”¨çŠ¶æ€
        $cardKeyModel->status = CardKey::STATUS_USED;
        $cardKeyModel->user_id = $userId;
        $cardKeyModel->use_time = date('Y-m-d H:i:s');
        $cardKeyModel->save();
        
        // 3. è®°å½•ä½¿ç”¨æ—¥å¿—
        CardKeyLog::create([...]);
        
        return [
            'success' => true,
            'message' => 'ä½¿ç”¨æˆåŠŸ',
            'data' => $cardKeyModel
        ];
    } catch (\Exception $e) {
        return [
            'success' => false,
            'message' => 'ä½¿ç”¨å¤±è´¥ï¼š' . $e->getMessage()
        ];
    }
}
```

### âŒ å½“å‰é—®é¢˜

1. **æ²¡æœ‰æ ¹æ®å¡å¯†ç±»å‹å¤„ç†ä¸šåŠ¡é€»è¾‘**
   - ä¸åŒç±»å‹çš„å¡å¯†åº”è¯¥æœ‰ä¸åŒçš„æ•ˆæœ
   - ç›®å‰åªæ˜¯ç®€å•æ ‡è®°ä¸º"å·²ä½¿ç”¨"

2. **æ²¡æœ‰ç»™ç”¨æˆ·å¢åŠ ä¼šå‘˜æ—¶é•¿**
   - `cardType.membership_duration` å­—æ®µæœªä½¿ç”¨
   - æ²¡æœ‰è®¡ç®—å’Œæ›´æ–°ç”¨æˆ·çš„ä¼šå‘˜åˆ°æœŸæ—¶é—´

3. **æ²¡æœ‰åŒºåˆ†å¡å¯†ç±»å‹çš„ä¸šåŠ¡å«ä¹‰**
   - VIP å…‘æ¢ç ï¼šåº”è¯¥å¢åŠ ä¼šå‘˜æ—¶é•¿
   - å•†å“å…‘æ¢ç ï¼šåº”è¯¥å‘æ”¾å•†å“/ç§¯åˆ†
   - ä¼˜æƒ åˆ¸ï¼šåº”è¯¥ç”Ÿæˆä¼˜æƒ åˆ¸è®°å½•
   - ä½“éªŒå¡ï¼šåº”è¯¥è®¾ç½®ä¸´æ—¶æƒé™

---

## âœ… æ”¹è¿›å»ºè®®

### æ–¹æ¡ˆ 1ï¼šæ ¹æ®ä¼šå‘˜æ—¶é•¿å¤„ç†ï¼ˆæ¨èï¼‰

é€‚ç”¨äºæ‰€æœ‰å¡å¯†éƒ½æ˜¯ç»™ç”¨æˆ·å¢åŠ ä¼šå‘˜æ—¶é•¿çš„åœºæ™¯ã€‚

```php
public function use(string $cardKey, int $userId, array $extra = []): array
{
    try {
        // 1. éªŒè¯å¡å¯†
        $verifyResult = CardKeyUtil::verify($cardKey);
        if (!$verifyResult['success']) {
            return $verifyResult;
        }

        $cardKeyModel = $verifyResult['data'];
        $cardType = $cardKeyModel->cardType;
        
        // 2. æ›´æ–°ä¸ºå·²ä½¿ç”¨çŠ¶æ€
        $cardKeyModel->status = CardKey::STATUS_USED;
        $cardKeyModel->user_id = $userId;
        $cardKeyModel->use_time = date('Y-m-d H:i:s');
        $cardKeyModel->save();
        
        // 3. å¤„ç†ä¼šå‘˜æ—¶é•¿é€»è¾‘
        if ($cardType && isset($cardType->membership_duration)) {
            $this->processUserMembership($userId, $cardType->membership_duration);
        }
        
        // 4. è®°å½•ä½¿ç”¨æ—¥å¿—
        CardKeyLog::create([
            'card_key_id' => $cardKeyModel->id,
            'user_id' => $userId,
            'action' => 'use',
            'ip' => $extra['ip'] ?? '',
            'user_agent' => $extra['user_agent'] ?? '',
            'remark' => $extra['remark'] ?? '',
            'create_time' => date('Y-m-d H:i:s')
        ]);
        
        return [
            'success' => true,
            'message' => 'ä½¿ç”¨æˆåŠŸ',
            'data' => [
                'card_key' => $cardKeyModel,
                'membership_info' => $this->getUserMembershipInfo($userId)
            ]
        ];
    } catch (\Exception $e) {
        return [
            'success' => false,
            'message' => 'ä½¿ç”¨å¤±è´¥ï¼š' . $e->getMessage()
        ];
    }
}

/**
 * å¤„ç†ç”¨æˆ·ä¼šå‘˜æ—¶é•¿
 * 
 * @param int $userId ç”¨æˆ·ID
 * @param int $durationMinutes ä¼šå‘˜æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
 */
private function processUserMembership(int $userId, int $durationMinutes): void
{
    // è·å–ç”¨æˆ·æ¨¡å‹
    $user = User::find($userId);
    if (!$user) {
        throw new \Exception('ç”¨æˆ·ä¸å­˜åœ¨');
    }
    
    // 0 = æ°¸ä¹…ä¼šå‘˜
    if ($durationMinutes === 0) {
        $user->vip_expire_time = null; // null è¡¨ç¤ºæ°¸ä¹…
        $user->is_vip = 1;
    } else {
        // è®¡ç®—åˆ°æœŸæ—¶é—´
        $currentExpireTime = $user->vip_expire_time;
        
        if ($currentExpireTime && strtotime($currentExpireTime) > time()) {
            // å¦‚æœå½“å‰ä¼šå‘˜æœªè¿‡æœŸï¼Œåœ¨ç°æœ‰æ—¶é—´åŸºç¡€ä¸Šç´¯åŠ 
            $newExpireTime = date('Y-m-d H:i:s', strtotime($currentExpireTime) + ($durationMinutes * 60));
        } else {
            // å¦‚æœå½“å‰ä¼šå‘˜å·²è¿‡æœŸæˆ–æ²¡æœ‰ä¼šå‘˜ï¼Œä»ç°åœ¨å¼€å§‹è®¡ç®—
            $newExpireTime = date('Y-m-d H:i:s', time() + ($durationMinutes * 60));
        }
        
        $user->vip_expire_time = $newExpireTime;
        $user->is_vip = 1;
    }
    
    $user->save();
}

/**
 * è·å–ç”¨æˆ·ä¼šå‘˜ä¿¡æ¯
 */
private function getUserMembershipInfo(int $userId): array
{
    $user = User::find($userId);
    if (!$user) {
        return [];
    }
    
    return [
        'is_vip' => $user->is_vip,
        'vip_expire_time' => $user->vip_expire_time,
        'is_permanent' => $user->vip_expire_time === null && $user->is_vip
    ];
}
```

---

### æ–¹æ¡ˆ 2ï¼šæ ¹æ®ç±»å‹ä»£ç åŒºåˆ†ä¸šåŠ¡é€»è¾‘

é€‚ç”¨äºå¡å¯†ç±»å‹æœ‰ä¸åŒä¸šåŠ¡å«ä¹‰çš„åœºæ™¯ã€‚

```php
public function use(string $cardKey, int $userId, array $extra = []): array
{
    try {
        $verifyResult = CardKeyUtil::verify($cardKey);
        if (!$verifyResult['success']) {
            return $verifyResult;
        }

        $cardKeyModel = $verifyResult['data'];
        $cardType = $cardKeyModel->cardType;
        
        // æ›´æ–°ä¸ºå·²ä½¿ç”¨çŠ¶æ€
        $cardKeyModel->status = CardKey::STATUS_USED;
        $cardKeyModel->user_id = $userId;
        $cardKeyModel->use_time = date('Y-m-d H:i:s');
        $cardKeyModel->save();
        
        // æ ¹æ®ç±»å‹ä»£ç å¤„ç†ä¸åŒä¸šåŠ¡é€»è¾‘
        $result = $this->processByCardType($userId, $cardType);
        
        // è®°å½•ä½¿ç”¨æ—¥å¿—
        CardKeyLog::create([...]);
        
        return [
            'success' => true,
            'message' => 'ä½¿ç”¨æˆåŠŸ',
            'data' => [
                'card_key' => $cardKeyModel,
                'result' => $result
            ]
        ];
    } catch (\Exception $e) {
        return [...];
    }
}

/**
 * æ ¹æ®å¡å¯†ç±»å‹å¤„ç†ä¸šåŠ¡é€»è¾‘
 */
private function processByCardType(int $userId, $cardType): array
{
    if (!$cardType) {
        return [];
    }
    
    switch ($cardType->type_code) {
        case 'VIP_CARD':
            // VIP å…‘æ¢ç ï¼šå¢åŠ ä¼šå‘˜æ—¶é•¿
            return $this->processVipCard($userId, $cardType);
            
        case 'PRODUCT_CARD':
            // å•†å“å…‘æ¢ç ï¼šå‘æ”¾å•†å“æˆ–ç§¯åˆ†
            return $this->processProductCard($userId, $cardType);
            
        case 'COUPON_CARD':
            // ä¼˜æƒ åˆ¸ï¼šç”Ÿæˆä¼˜æƒ åˆ¸è®°å½•
            return $this->processCouponCard($userId, $cardType);
            
        case 'TRIAL_CARD':
            // ä½“éªŒå¡ï¼šè®¾ç½®ä¸´æ—¶æƒé™
            return $this->processTrialCard($userId, $cardType);
            
        default:
            // é»˜è®¤ï¼šå¢åŠ ä¼šå‘˜æ—¶é•¿
            return $this->processVipCard($userId, $cardType);
    }
}

/**
 * å¤„ç† VIP å…‘æ¢ç 
 */
private function processVipCard(int $userId, $cardType): array
{
    $this->processUserMembership($userId, $cardType->membership_duration);
    return $this->getUserMembershipInfo($userId);
}

/**
 * å¤„ç†å•†å“å…‘æ¢ç 
 */
private function processProductCard(int $userId, $cardType): array
{
    // å‘æ”¾å•†å“ã€ç§¯åˆ†ç­‰
    // TODO: å®ç°å…·ä½“é€»è¾‘
    return ['type' => 'product', 'processed' => true];
}

/**
 * å¤„ç†ä¼˜æƒ åˆ¸
 */
private function processCouponCard(int $userId, $cardType): array
{
    // ç”Ÿæˆä¼˜æƒ åˆ¸è®°å½•
    // TODO: å®ç°å…·ä½“é€»è¾‘
    return ['type' => 'coupon', 'processed' => true];
}

/**
 * å¤„ç†ä½“éªŒå¡
 */
private function processTrialCard(int $userId, $cardType): array
{
    // è®¾ç½®ä¸´æ—¶ä½“éªŒæƒé™
    // TODO: å®ç°å…·ä½“é€»è¾‘
    return ['type' => 'trial', 'processed' => true];
}
```

---

## ğŸ—„ï¸ æ•°æ®åº“å­—æ®µå»ºè®®

### ç”¨æˆ·è¡¨ï¼ˆusersï¼‰éœ€è¦çš„å­—æ®µ

```sql
ALTER TABLE `users` ADD COLUMN `is_vip` TINYINT(1) DEFAULT 0 COMMENT 'æ˜¯å¦æ˜¯VIPä¼šå‘˜ 0=å¦ 1=æ˜¯';
ALTER TABLE `users` ADD COLUMN `vip_expire_time` DATETIME NULL COMMENT 'VIPåˆ°æœŸæ—¶é—´ NULL=æ°¸ä¹…ä¼šå‘˜';
ALTER TABLE `users` ADD COLUMN `vip_level` INT DEFAULT 1 COMMENT 'VIPç­‰çº§';
```

### å¡å¯†ç±»å‹è¡¨ï¼ˆcard_typesï¼‰å·²æœ‰å­—æ®µ

```sql
-- å·²æœ‰å­—æ®µ
membership_duration INT NULL COMMENT 'ä¼šå‘˜æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰ 0=æ°¸ä¹… NULL=æ— æ—¶é•¿'
available_days INT NULL COMMENT 'å¯ç”¨å¤©æ•° NULL=æ°¸ä¹…å¯ç”¨'
```

---

## ğŸ“Š ä½¿ç”¨æµç¨‹å›¾

```
ç”¨æˆ·ä½¿ç”¨å¡å¯†
    â†“
éªŒè¯å¡å¯†ï¼ˆçŠ¶æ€ã€è¿‡æœŸç­‰ï¼‰
    â†“
è·å–å¡å¯†ç±»å‹ä¿¡æ¯
    â†“
æ ¹æ®ç±»å‹å¤„ç†ä¸šåŠ¡é€»è¾‘
    â”œâ”€ VIPå¡ï¼šå¢åŠ ä¼šå‘˜æ—¶é•¿
    â”œâ”€ å•†å“å¡ï¼šå‘æ”¾å•†å“/ç§¯åˆ†
    â”œâ”€ ä¼˜æƒ åˆ¸ï¼šç”Ÿæˆä¼˜æƒ åˆ¸
    â””â”€ ä½“éªŒå¡ï¼šä¸´æ—¶æƒé™
    â†“
æ›´æ–°å¡å¯†çŠ¶æ€ä¸ºå·²ä½¿ç”¨
    â†“
è®°å½•ä½¿ç”¨æ—¥å¿—
    â†“
è¿”å›å¤„ç†ç»“æœ
```

---

## ğŸ¯ æ¨èå®ç°æ­¥éª¤

1. **ç¬¬ä¸€æ­¥**ï¼šå®ç°æ–¹æ¡ˆ1ï¼ˆä¼šå‘˜æ—¶é•¿å¤„ç†ï¼‰
   - æ·»åŠ ç”¨æˆ·è¡¨å­—æ®µ
   - å®ç° `processUserMembership` æ–¹æ³•
   - æµ‹è¯•ä¼šå‘˜æ—¶é•¿ç´¯åŠ é€»è¾‘

2. **ç¬¬äºŒæ­¥**ï¼ˆå¯é€‰ï¼‰ï¼šæ‰©å±•æ–¹æ¡ˆ2ï¼ˆå¤šç±»å‹æ”¯æŒï¼‰
   - å®šä¹‰ç±»å‹ä»£ç å¸¸é‡
   - å®ç°å„ç±»å‹çš„å¤„ç†æ–¹æ³•
   - æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€æ­¥å®Œå–„

3. **ç¬¬ä¸‰æ­¥**ï¼šå®Œå–„æ—¥å¿—è®°å½•
   - è®°å½•ä¼šå‘˜å˜æ›´å‰åçš„çŠ¶æ€
   - è®°å½•å…·ä½“çš„ä¸šåŠ¡å¤„ç†ç»“æœ

---

## ğŸ’¡ æ³¨æ„äº‹é¡¹

1. **äº‹åŠ¡å¤„ç†**ï¼šä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
2. **å¹¶å‘æ§åˆ¶**ï¼šé˜²æ­¢åŒä¸€å¼ å¡å¯†è¢«é‡å¤ä½¿ç”¨
3. **å¼‚å¸¸å¤„ç†**ï¼šå¤±è´¥æ—¶å›æ»šæ‰€æœ‰æ“ä½œ
4. **æ—¥å¿—å®Œæ•´æ€§**ï¼šè®°å½•è¯¦ç»†çš„æ“ä½œä¿¡æ¯ä¾¿äºè¿½æº¯

---

## ğŸ“ ç¤ºä¾‹ï¼šå®Œæ•´çš„äº‹åŠ¡å®ç°

```php
use think\facade\Db;

public function use(string $cardKey, int $userId, array $extra = []): array
{
    // å¼€å¯äº‹åŠ¡
    Db::startTrans();
    
    try {
        // 1. éªŒè¯å¡å¯†ï¼ˆåŠ é”é˜²æ­¢å¹¶å‘ï¼‰
        $verifyResult = CardKeyUtil::verify($cardKey);
        if (!$verifyResult['success']) {
            Db::rollback();
            return $verifyResult;
        }

        $cardKeyModel = $verifyResult['data'];
        
        // 2. å†æ¬¡æ£€æŸ¥çŠ¶æ€ï¼ˆåŒé‡éªŒè¯ï¼‰
        if ($cardKeyModel->status !== CardKey::STATUS_UNUSED) {
            Db::rollback();
            return [
                'success' => false,
                'message' => 'å¡å¯†å·²è¢«ä½¿ç”¨æˆ–ç¦ç”¨'
            ];
        }
        
        // 3. æ›´æ–°å¡å¯†çŠ¶æ€
        $cardKeyModel->status = CardKey::STATUS_USED;
        $cardKeyModel->user_id = $userId;
        $cardKeyModel->use_time = date('Y-m-d H:i:s');
        $cardKeyModel->save();
        
        // 4. å¤„ç†ä¸šåŠ¡é€»è¾‘
        $cardType = $cardKeyModel->cardType;
        if ($cardType && isset($cardType->membership_duration)) {
            $this->processUserMembership($userId, $cardType->membership_duration);
        }
        
        // 5. è®°å½•æ—¥å¿—
        CardKeyLog::create([...]);
        
        // æäº¤äº‹åŠ¡
        Db::commit();
        
        return [
            'success' => true,
            'message' => 'ä½¿ç”¨æˆåŠŸ',
            'data' => [
                'card_key' => $cardKeyModel,
                'membership_info' => $this->getUserMembershipInfo($userId)
            ]
        ];
        
    } catch (\Exception $e) {
        // å›æ»šäº‹åŠ¡
        Db::rollback();
        
        return [
            'success' => false,
            'message' => 'ä½¿ç”¨å¤±è´¥ï¼š' . $e->getMessage()
        ];
    }
}
```

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

- åç«¯ Service: `src/admin/m-service-server/app/api/services/CardKeyService.php`
- åç«¯ Controller: `src/admin/m-service-server/app/api/controller/v1/CardKey.php`
- å‰ç«¯ API: `src/api/cardKey.ts`
- å‰ç«¯ç»„ä»¶: `src/views/basic/cardKey.vue`

