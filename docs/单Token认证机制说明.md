# å•Tokenè®¤è¯æœºåˆ¶è¯´æ˜æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬é¡¹ç›®é‡‡ç”¨å•Tokenè®¤è¯æœºåˆ¶ï¼Œé€šè¿‡æ™ºèƒ½ç»­ç­¾å®ç°æ— æ„Ÿåˆ·æ–°ï¼Œç¡®ä¿å®‰å…¨æ€§å’Œè‰¯å¥½çš„ç”¨æˆ·ä½“éªŒã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒç†å¿µ
- **å•ä¸€Token**: ä½¿ç”¨ä¸€ä¸ªè®¿é—®ä»¤ç‰Œï¼Œç®€åŒ–ç®¡ç†
- **æ™ºèƒ½ç»­ç­¾**: æå‰æ£€æµ‹è¿‡æœŸæ—¶é—´ï¼Œè‡ªåŠ¨ç»­ç­¾
- **æ— æ„Ÿåˆ·æ–°**: ç”¨æˆ·æ— æ„ŸçŸ¥çš„tokenæ›´æ–°
- **åŒé‡å­˜å‚¨**: Cookie + LocalStorageï¼Œç¡®ä¿æ•°æ®å®‰å…¨å’Œå¯ç”¨æ€§

### æ–‡ä»¶ç»“æ„
```
src/
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ auth.ts              # Tokenç®¡ç†æ ¸å¿ƒå·¥å…·
â”‚   â”œâ”€â”€ tokenManager.ts      # Tokenè‡ªåŠ¨ç»­ç­¾ç®¡ç†å™¨
â”‚   â””â”€â”€ http/
â”‚       â””â”€â”€ index.ts         # HTTPæ‹¦æˆªå™¨
â”œâ”€â”€ store/modules/
â”‚   â””â”€â”€ user.ts              # ç”¨æˆ·çŠ¶æ€ç®¡ç†
â”œâ”€â”€ api/
â”‚   â””â”€â”€ user.ts              # ç”¨æˆ·ç›¸å…³API
â””â”€â”€ views/login/
    â””â”€â”€ index.vue            # ç™»å½•é¡µé¢
```

## ğŸ”§ æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. Tokenæ•°æ®ç»“æ„ (`src/utils/auth.ts`)

```typescript
export interface DataInfo<T> {
  token: string;              // è®¿é—®ä»¤ç‰Œ
  expires: T;                 // tokenè¿‡æœŸæ—¶é—´æˆ³
  id?: number;               // ç”¨æˆ·ID
  avatar?: string;           // å¤´åƒURL
  username?: string;         // ç”¨æˆ·å
  nickname?: string;         // æ˜µç§°
  roles?: Array<string>;     // è§’è‰²æ•°ç»„
  permissions?: Array<string>; // æƒé™æ•°ç»„
}
```

### 2. Tokenå­˜å‚¨ç­–ç•¥

```typescript
// Cookieå­˜å‚¨ï¼ˆå¸¦è¿‡æœŸæ—¶é—´ï¼‰
const cookieData = {
  token: "eyJhbGciOiJIUzUxMiJ9...",
  expires: 1640995199000  // æ—¶é—´æˆ³
};
Cookies.set("authorized-token", JSON.stringify(cookieData), {
  expires: (expires - Date.now()) / 86400000  // å¤©æ•°
});

// LocalStorageå­˜å‚¨ï¼ˆç”¨æˆ·ä¿¡æ¯ï¼‰
const userInfo = {
  id: 1,
  avatar: "avatar.jpg", 
  username: "admin",
  nickname: "ç®¡ç†å‘˜",
  roles: ["admin"],
  permissions: ["*:*:*"],
  token: "eyJhbGciOiJIUzUxMiJ9...",
  expires: 1640995199000
};
localStorage.setItem("user-info", JSON.stringify(userInfo));
```

### 3. æ™ºèƒ½ç»­ç­¾æœºåˆ¶ (`src/utils/tokenManager.ts`)

#### æ ¸å¿ƒç‰¹æ€§
- **æå‰ç»­ç­¾**: Tokenå‰©ä½™10åˆ†é’Ÿæ—¶å¼€å§‹ç»­ç­¾
- **å¹¶å‘ä¿æŠ¤**: é˜²æ­¢å¤šä¸ªè¯·æ±‚åŒæ—¶è§¦å‘ç»­ç­¾
- **é‡è¯•æœºåˆ¶**: ç»­ç­¾å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œç”¨æˆ·æç¤º

#### å·¥ä½œæµç¨‹
```typescript
// 1. æ£€æŸ¥Tokenæ˜¯å¦éœ€è¦ç»­ç­¾
const timeLeft = expiresTime - now;
if (timeLeft <= REFRESH_THRESHOLD) {
  // 2. è°ƒç”¨ç»­ç­¾æ¥å£
  const response = await http.request('post', '/api/v1/auth/refresh', {
    data: { token: currentToken.token }
  });
  
  // 3. ä¿å­˜æ–°Token
  setToken(newTokenData);
}
```

## ğŸ”„ APIæ¥å£è§„èŒƒ

### 1. ç™»å½•æ¥å£

**URL**: `POST /api/v1/user/login`

**è¯·æ±‚å‚æ•°**:
```json
{
  "account": "admin",
  "password": "123456", 
  "action": "pwd"
}
```

**å“åº”æ ¼å¼**:
```json
{
  "code": 200,
  "msg": "ç™»å½•æˆåŠŸ",
  "token": "eyJhbGciOiJIUzUxMiJ9...",
  "expireTime": 1640995199,  // è¿‡æœŸæ—¶é—´æˆ³ï¼ˆç§’ï¼‰
  "data": {
    "id": 1,
    "avatar": "avatar.jpg",
    "username": "admin",
    "nickname": "ç®¡ç†å‘˜", 
    "roles": [
      {
        "iden": "admin",
        "permissions": [
          {"name": "*:*:*"}
        ]
      }
    ]
  }
}
```

### 2. Tokenç»­ç­¾æ¥å£

**URL**: `POST /api/v1/auth/refresh`

**è¯·æ±‚å‚æ•°**:
```json
{
  "token": "current_token_here"
}
```

**å“åº”æ ¼å¼**:
```json
{
  "code": 200,
  "msg": "ç»­ç­¾æˆåŠŸ",
  "token": "new_token_here",
  "expireTime": 1640998799  // æ–°çš„è¿‡æœŸæ—¶é—´æˆ³ï¼ˆç§’ï¼‰
}
```

## ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹

### ç™»å½•æµç¨‹
1. ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå¯†ç 
2. å‰ç«¯è°ƒç”¨ `/api/v1/user/login` æ¥å£
3. åç«¯éªŒè¯å‡­æ®ï¼Œè¿”å›ç”¨æˆ·ä¿¡æ¯å’ŒToken
4. å‰ç«¯è§£ææ•°æ®ï¼Œä¿å­˜åˆ°Cookieå’ŒLocalStorage
5. è·³è½¬åˆ°ä¸»é¡µé¢

### APIè¯·æ±‚æµç¨‹
1. å‘èµ·APIè¯·æ±‚
2. æ‹¦æˆªå™¨æ£€æŸ¥Tokenæ˜¯å¦å³å°†è¿‡æœŸï¼ˆå‰©ä½™10åˆ†é’Ÿï¼‰
3. å¦‚æœå³å°†è¿‡æœŸï¼Œè‡ªåŠ¨è°ƒç”¨ç»­ç­¾æ¥å£
4. è·å–æ–°Tokenï¼Œæ›´æ–°æœ¬åœ°å­˜å‚¨
5. é‡æ–°å‘èµ·åŸå§‹è¯·æ±‚
6. è¿”å›APIå“åº”

### Tokenç»­ç­¾æµç¨‹
1. tokenManageræ£€æµ‹åˆ°Tokenå³å°†è¿‡æœŸ
2. ä½¿ç”¨å½“å‰Tokenè°ƒç”¨ `/api/v1/auth/refresh` æ¥å£
3. åç«¯éªŒè¯Tokenæœ‰æ•ˆæ€§
4. è¿”å›æ–°çš„Tokenå’Œè¿‡æœŸæ—¶é—´
5. æ›´æ–°æœ¬åœ°å­˜å‚¨
6. ç»§ç»­æ‰§è¡ŒåŸå§‹è¯·æ±‚

## ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

### å¤šé‡ä¿æŠ¤
- **æ—¶æ•ˆæ€§**: TokençŸ­æœŸæœ‰æ•ˆï¼ˆ2å°æ—¶ï¼‰ï¼Œé™ä½æ³„éœ²é£é™©
- **åŒé‡å­˜å‚¨**: Cookieå’ŒLocalStorageäº’ä¸ºå¤‡ä»½
- **è‡ªåŠ¨æ¸…ç†**: Tokenè¿‡æœŸæˆ–æ— æ•ˆæ—¶è‡ªåŠ¨æ¸…é™¤æœ¬åœ°æ•°æ®
- **è¯·æ±‚é˜Ÿåˆ—**: é¿å…å¹¶å‘ç»­ç­¾å¯¼è‡´çš„é—®é¢˜

### å¼‚å¸¸å¤„ç†
- **ç½‘ç»œå¼‚å¸¸**: è‡ªåŠ¨é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š2æ¬¡ï¼‰
- **Tokenæ— æ•ˆ**: è‡ªåŠ¨è·³è½¬ç™»å½•é¡µ
- **ç»­ç­¾å¤±è´¥**: æ¸…é™¤æœ¬åœ°æ•°æ®ï¼Œè¦æ±‚é‡æ–°ç™»å½•

## ğŸ“± å¤šæ ‡ç­¾é¡µæ”¯æŒ

é€šè¿‡Cookieå…±äº«æœºåˆ¶ï¼Œæ”¯æŒå¤šä¸ªæµè§ˆå™¨æ ‡ç­¾é¡µåŒæ—¶ä½¿ç”¨ï¼š
- ä¸€ä¸ªæ ‡ç­¾é¡µåˆ·æ–°Tokenï¼Œå…¶ä»–æ ‡ç­¾é¡µè‡ªåŠ¨è·å–æ–°Token
- ä¸€ä¸ªæ ‡ç­¾é¡µé€€å‡ºç™»å½•ï¼Œå…¶ä»–æ ‡ç­¾é¡µåŒæ­¥é€€å‡º

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### å‰ç«¯è°ƒç”¨
```typescript
// ç™»å½•
const userInfo = await useUserStoreHook().loginByUsername({
  account: "admin",
  password: "123456",
  action: "pwd"
});

// è·å–å½“å‰Token
const tokenData = getToken();

// æ‰‹åŠ¨è§¦å‘ç»­ç­¾
await tokenManager.forceRefreshToken();

// é€€å‡ºç™»å½•
useUserStoreHook().logOut();
```

### HTTPè¯·æ±‚è‡ªåŠ¨å¤„ç†
```typescript
// æ‰€æœ‰APIè¯·æ±‚éƒ½ä¼šè‡ªåŠ¨æ·»åŠ Tokenåˆ°è¯·æ±‚å¤´
const response = await http.request('get', '/api/v1/user/profile');

// Tokenå³å°†è¿‡æœŸæ—¶ä¼šè‡ªåŠ¨ç»­ç­¾ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥
```

## ğŸ“‹ æ€»ç»“

å•Tokenè®¤è¯æœºåˆ¶å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

1. **å®ç°ç®€å•**: åªéœ€è¦ç®¡ç†ä¸€ç§token
2. **æ€§èƒ½æ›´å¥½**: å‡å°‘äº†tokenå­˜å‚¨å’ŒéªŒè¯çš„å¤æ‚åº¦
3. **è¶³å¤Ÿå®‰å…¨**: é€šè¿‡çŸ­æœŸæœ‰æ•ˆæœŸ+æ™ºèƒ½ç»­ç­¾ä¿è¯å®‰å…¨æ€§
4. **ç”¨æˆ·ä½“éªŒå¥½**: æ— æ„Ÿåˆ·æ–°ï¼Œé•¿æœŸä¿æŒç™»å½•çŠ¶æ€
5. **ç»´æŠ¤æ–¹ä¾¿**: ä»£ç é€»è¾‘æ¸…æ™°ï¼Œæ˜“äºè°ƒè¯•å’Œç»´æŠ¤

è¿™å¥—å•Tokenæœºåˆ¶ç»è¿‡ç²¾å¿ƒè®¾è®¡ï¼Œå®Œå…¨æ»¡è¶³ç°ä»£Webåº”ç”¨çš„è®¤è¯éœ€æ±‚ã€‚
