# Tokenæ— æ„Ÿç»­ç­¾ - åç«¯å¯¹æ¥æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

å‰ç«¯å·²å®ç°Tokenæ— æ„Ÿç»­ç­¾æœºåˆ¶ï¼Œå½“Tokenå‰©ä½™10åˆ†é’Ÿæ—¶ä¼šè‡ªåŠ¨è°ƒç”¨ç»­ç­¾æ¥å£ï¼Œå®ç°ç”¨æˆ·æ— æ„ŸçŸ¥çš„ç™»å½•çŠ¶æ€å»¶ç»­ã€‚

## ğŸ”§ å‰ç«¯å·²å®ç°åŠŸèƒ½

### è‡ªåŠ¨ç»­ç­¾æœºåˆ¶
- âœ… Tokenå‰©ä½™10åˆ†é’Ÿæ—¶è‡ªåŠ¨ç»­ç­¾
- âœ… é˜²æ­¢å¹¶å‘ç»­ç­¾è¯·æ±‚
- âœ… ç»­ç­¾å¤±è´¥è‡ªåŠ¨é‡è¯•ï¼ˆæœ€å¤š2æ¬¡ï¼Œé—´éš”1ç§’ï¼‰
- âœ… ä¸é˜»å¡å½“å‰è¯·æ±‚ï¼Œåå°é™é»˜å¤„ç†
- âœ… Cookieè‡ªåŠ¨è¿‡æœŸæœºåˆ¶

### è¯·æ±‚æ–¹å¼
- âœ… æ‰€æœ‰APIè¯·æ±‚é€šè¿‡ `Authorization: Bearer {token}` å¤´éƒ¨å‘é€
- âœ… ç»­ç­¾è¯·æ±‚é€šè¿‡ `data` å‚æ•°å‘é€token

## ğŸš€ åç«¯éœ€è¦å®ç°çš„æ¥å£

### ç»­ç­¾æ¥å£è§„èŒƒ

**æ¥å£åœ°å€**: `POST /api/v1/auth/refresh`

**è¯·æ±‚å‚æ•°**:
```json
{
  "token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
}
```

**æˆåŠŸå“åº”** (HTTP 200):
```json
{
  "code": 200,
  "msg": "Tokenç»­ç­¾æˆåŠŸ",
  "token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
  "expireTime": 1756050226
}
```

**å¤±è´¥å“åº”** (HTTP 401):
```json
{
  "code": 401,
  "msg": "Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ"
}
```

**å…¶ä»–é”™è¯¯å“åº”**:
```json
{
  "code": 400,
  "msg": "Tokenä¸èƒ½ä¸ºç©º"
}
```

```json
{
  "code": 500,
  "msg": "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯"
}
```

## ğŸ” åç«¯å¤„ç†é€»è¾‘å»ºè®®

### åŸºæœ¬æµç¨‹
1. **æ¥æ”¶è¯·æ±‚**: ä» `data.token` è·å–æ—§token
2. **éªŒè¯token**: æ£€æŸ¥tokenæ ¼å¼ã€ç­¾åå’Œæœ‰æ•ˆæ€§
3. **å…è®¸ç»­ç­¾**: å³å°†è¿‡æœŸæˆ–åˆšè¿‡æœŸä¸ä¹…çš„tokenå¯ä»¥ç»­ç­¾
4. **ç”Ÿæˆæ–°token**: ä¿æŒç”¨æˆ·ä¿¡æ¯ä¸€è‡´ï¼Œå»¶é•¿è¿‡æœŸæ—¶é—´
5. **è¿”å›å“åº”**: åŒ…å«æ–°tokenå’Œè¿‡æœŸæ—¶é—´

### å…³é”®å®ç°è¦ç‚¹

#### 1. TokenéªŒè¯
```python
# ç¤ºä¾‹ï¼šå…è®¸å³å°†è¿‡æœŸçš„tokenç»­ç­¾
try:
    # æ­£å¸¸éªŒè¯
    decoded = jwt.decode(old_token, JWT_SECRET, algorithms=['HS256'])
except jwt.ExpiredSignatureError:
    # å…è®¸è¿‡æœŸçš„tokenåœ¨ä¸€å®šæ—¶é—´å†…ç»­ç­¾
    decoded = jwt.decode(old_token, JWT_SECRET, algorithms=['HS256'], 
                        options={"verify_exp": False})
    
    # æ£€æŸ¥è¿‡æœŸæ—¶é—´ï¼Œè¶…è¿‡1å°æ—¶ä¸å…è®¸ç»­ç­¾
    exp_time = decoded.get('exp', 0)
    if time.time() - exp_time > 3600:
        return error_response(401, 'Tokenå·²è¿‡æœŸå¤ªä¹…ï¼Œè¯·é‡æ–°ç™»å½•')
```

#### 2. æ–°Tokenç”Ÿæˆ
```python
# ç”Ÿæˆæ–°tokenï¼Œå»¶é•¿24å°æ—¶
new_expire_time = int(time.time()) + 24 * 60 * 60
new_token = jwt.encode({
    'iss': '',
    'aud': '',
    'iat': int(time.time()),
    'nbf': int(time.time()),
    'exp': new_expire_time,
    'data': {
        'loginTime': int(time.time()),
        'account': decoded.get('data', {}).get('account'),
        'id': user_id,
        'platform': 'Web',
        'fingerprint': decoded.get('data', {}).get('fingerprint')
    }
}, JWT_SECRET, algorithm='HS256')
```

## ğŸ¯ å…³é”®è¦ç‚¹

### 1. ç»­ç­¾æ—¶æœº
- å‰ç«¯åœ¨tokenå‰©ä½™10åˆ†é’Ÿæ—¶è‡ªåŠ¨è°ƒç”¨
- å»ºè®®å…è®¸å³å°†è¿‡æœŸæˆ–åˆšè¿‡æœŸä¸ä¹…çš„tokenç»­ç­¾
- å¯è®¾ç½®ç»­ç­¾æ—¶é—´çª—å£ï¼ˆå¦‚è¿‡æœŸå1å°æ—¶å†…å¯ç»­ç­¾ï¼‰

### 2. å®‰å…¨è€ƒè™‘
- éªŒè¯tokençš„å®Œæ•´æ€§å’Œç”¨æˆ·èº«ä»½
- è®¾ç½®åˆç†çš„ç»­ç­¾æ—¶é—´çª—å£
- ç”Ÿæˆæ–°tokenæ—¶ä¿æŒç”¨æˆ·ä¿¡æ¯ä¸€è‡´
- è®°å½•ç»­ç­¾æ—¥å¿—ä¾¿äºå®¡è®¡

### 3. å“åº”æ ¼å¼è¦æ±‚
- **å¿…é¡»å­—æ®µ**: `code`, `msg`, `token`, `expireTime`
- **expireTime**: ä½¿ç”¨ç§’çº§æ—¶é—´æˆ³
- **é”™è¯¯å¤„ç†**: è¿”å›æ˜ç¡®çš„é”™è¯¯ç å’Œæ¶ˆæ¯

### 4. æ€§èƒ½ä¼˜åŒ–
- ç»­ç­¾æ¥å£åº”å¿«é€Ÿå“åº”ï¼ˆå»ºè®®<500msï¼‰
- å¯ä½¿ç”¨ç¼“å­˜å‡å°‘æ•°æ®åº“æŸ¥è¯¢
- é¿å…åœ¨ç»­ç­¾è¿‡ç¨‹ä¸­è¿›è¡Œå¤æ‚ä¸šåŠ¡é€»è¾‘

## ğŸ”„ å®Œæ•´äº¤äº’æµç¨‹

```
1. å‰ç«¯æ£€æµ‹Tokenå‰©ä½™10åˆ†é’Ÿ
2. å‰ç«¯è°ƒç”¨ POST /api/v1/auth/refresh
3. åç«¯éªŒè¯æ—§token
4. åç«¯ç”Ÿæˆæ–°token
5. åç«¯è¿”å›æ–°tokenå’Œè¿‡æœŸæ—¶é—´
6. å‰ç«¯ä¿å­˜æ–°tokenåˆ°Cookie
7. å‰ç«¯ç»§ç»­ä½¿ç”¨æ–°tokenå‘é€åŸå§‹è¯·æ±‚
```

## âœ… æµ‹è¯•ç”¨ä¾‹å»ºè®®

### æ­£å¸¸åœºæ™¯
- ä½¿ç”¨å³å°†è¿‡æœŸçš„æœ‰æ•ˆtokenæµ‹è¯•ç»­ç­¾
- éªŒè¯è¿”å›çš„æ–°tokenæ ¼å¼æ­£ç¡®
- éªŒè¯æ–°tokençš„è¿‡æœŸæ—¶é—´å»¶é•¿

### å¼‚å¸¸åœºæ™¯
- ä½¿ç”¨å·²è¿‡æœŸå¾ˆä¹…çš„token
- ä½¿ç”¨æ ¼å¼é”™è¯¯çš„token
- ä½¿ç”¨è¢«ç¯¡æ”¹çš„token
- å¹¶å‘å‘é€å¤šä¸ªç»­ç­¾è¯·æ±‚
- ç»­ç­¾æ¥å£è¶…æ—¶æˆ–è¿”å›é”™è¯¯

### è¾¹ç•Œåœºæ™¯
- åˆšè¿‡æœŸå‡ åˆ†é’Ÿçš„token
- ç©ºtokenæˆ–nullå€¼
- è¶…é•¿tokenå­—ç¬¦ä¸²

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **æ—¶åŒºé—®é¢˜**: ç¡®ä¿æœåŠ¡å™¨æ—¶é—´ä¸å‰ç«¯æ—¶é—´åŒæ­¥
2. **å¹¶å‘å¤„ç†**: åŒä¸€ç”¨æˆ·å¯èƒ½åŒæ—¶å‘èµ·å¤šä¸ªç»­ç­¾è¯·æ±‚
3. **æ—¥å¿—è®°å½•**: è®°å½•ç»­ç­¾æˆåŠŸ/å¤±è´¥çš„æ—¥å¿—
4. **ç›‘æ§å‘Šè­¦**: ç›‘æ§ç»­ç­¾æ¥å£çš„æˆåŠŸç‡å’Œå“åº”æ—¶é—´
5. **é™çº§ç­–ç•¥**: ç»­ç­¾å¤±è´¥æ—¶å‰ç«¯ä¼šè‡ªåŠ¨è·³è½¬ç™»å½•é¡µ

## ğŸ“Š ç›‘æ§æŒ‡æ ‡å»ºè®®

- ç»­ç­¾æ¥å£è°ƒç”¨é‡
- ç»­ç­¾æˆåŠŸç‡
- ç»­ç­¾æ¥å£å“åº”æ—¶é—´
- ç»­ç­¾å¤±è´¥åŸå› åˆ†å¸ƒ
- ç”¨æˆ·é‡æ–°ç™»å½•é¢‘ç‡

## ğŸ”§ å‰ç«¯æŠ€æœ¯å®ç°

### TokenManageræ ¸å¿ƒåŠŸèƒ½
- æ™ºèƒ½æ£€æµ‹tokenè¿‡æœŸæ—¶é—´
- å¹¶å‘æ§åˆ¶é˜²æ­¢é‡å¤ç»­ç­¾
- å¤±è´¥é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š2æ¬¡ï¼‰
- é”™è¯¯åˆ†ç±»å¤„ç†å’Œç”¨æˆ·æç¤º

### é›†æˆæ–¹å¼
- HTTPè¯·æ±‚æ‹¦æˆªå™¨è‡ªåŠ¨æ£€æŸ¥token
- ç™½åå•æœºåˆ¶ï¼ˆç™»å½•ã€ç»­ç­¾æ¥å£é™¤å¤–ï¼‰
- ç»­ç­¾æˆåŠŸåè‡ªåŠ¨æ›´æ–°æœ¬åœ°å­˜å‚¨
- ç»­ç­¾å¤±è´¥è‡ªåŠ¨æ¸…ç†å¹¶è·³è½¬ç™»å½•é¡µ

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æ›´æ–°æ—¶é—´**: 2025-01-23  
**ç»´æŠ¤äººå‘˜**: å‰ç«¯å¼€å‘å›¢é˜Ÿ
