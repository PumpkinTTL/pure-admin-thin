<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文章权限测试工具</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 20px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'Courier New', monospace;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .result {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .result pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 13px;
            line-height: 1.6;
        }

        .success {
            color: #48bb78;
            font-weight: bold;
        }

        .error {
            color: #f56565;
            font-weight: bold;
        }

        .info {
            color: #4299e1;
            font-weight: bold;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
        }

        .status-logged-in {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-logged-out {
            background: #fed7d7;
            color: #742a2a;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        @media (max-width: 768px) {
            .btn-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔐 文章权限测试工具</h1>

        <!-- Token配置 -->
        <div class="card">
            <h2>1️⃣ Token配置</h2>
            <div class="form-group">
                <label>API地址:</label>
                <input type="text" id="apiUrl" value="http://localhost/api/v1" placeholder="http://your-api.com/api/v1">
            </div>
            <div class="form-group">
                <label>登录Token (Bearer Token):</label>
                <textarea id="token" placeholder="粘贴你的JWT Token..."></textarea>
            </div>
            <div class="form-group">
                <label>当前状态: <span id="loginStatus" class="status-badge status-logged-out">未登录</span></label>
            </div>
        </div>

        <!-- 快捷登录 -->
        <div class="card">
            <h2>2️⃣ 快捷登录</h2>
            <div class="grid">
                <div class="form-group">
                    <label>用户名:</label>
                    <input type="text" id="username" value="admin" placeholder="用户名">
                </div>
                <div class="form-group">
                    <label>密码:</label>
                    <input type="text" id="password" value="admin123" placeholder="密码">
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-success" onclick="login()">🔑 登录</button>
                <button class="btn btn-danger" onclick="clearToken()">🚪 登出</button>
            </div>
            <div id="loginResult" class="result" style="display:none;"></div>
        </div>

        <!-- 测试文章列表 -->
        <div class="card">
            <h2>3️⃣ 测试文章列表查询</h2>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="testArticleList(true)">📝 带Token查询</button>
                <button class="btn btn-primary" onclick="testArticleList(false)">🌐 不带Token查询</button>
            </div>
            <div id="articleResult" class="result" style="display:none;"></div>
        </div>

        <!-- 单篇文章测试 -->
        <div class="card">
            <h2>4️⃣ 测试单篇文章详情</h2>
            <div class="form-group">
                <label>文章ID:</label>
                <input type="text" id="articleId" value="99999" placeholder="输入文章ID">
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="testArticleDetail(true)">📖 带Token查询</button>
                <button class="btn btn-primary" onclick="testArticleDetail(false)">🌐 不带Token查询</button>
            </div>
            <div id="detailResult" class="result" style="display:none;"></div>
        </div>

        <!-- SQL测试 -->
        <div class="card">
            <h2>5️⃣ 数据库查询验证</h2>
            <p style="color: #718096; margin-bottom: 15px;">
                直接在数据库中执行以下SQL来验证文章可见性设置：
            </p>
            <textarea readonly style="background: #f7fafc; font-family: 'Courier New', monospace;">
-- 查看所有文章的可见性设置
SELECT id, title, author_id, visibility, status FROM bl_article ORDER BY id DESC LIMIT 20;

-- 查看登录可见的文章
SELECT id, title, visibility FROM bl_article WHERE visibility = 'login_required';

-- 查看指定用户权限
SELECT * FROM bl_article_user_access WHERE article_id = 99999;

-- 查看指定角色权限
SELECT * FROM bl_article_role_access WHERE article_id = 99999;
            </textarea>
        </div>
    </div>

    <script>
        // 更新登录状态显示
        function updateLoginStatus() {
            const token = document.getElementById('token').value.trim();
            const statusEl = document.getElementById('loginStatus');
            
            if (token) {
                statusEl.className = 'status-badge status-logged-in';
                statusEl.textContent = '已登录';
            } else {
                statusEl.className = 'status-badge status-logged-out';
                statusEl.textContent = '未登录';
            }
        }

        // 监听Token输入变化
        document.getElementById('token').addEventListener('input', updateLoginStatus);

        // 登录
        async function login() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const resultEl = document.getElementById('loginResult');

            if (!username || !password) {
                showResult(resultEl, '请输入用户名和密码', 'error');
                return;
            }

            try {
                resultEl.style.display = 'block';
                resultEl.innerHTML = '<pre><span class="info">正在登录...</span></pre>';

                const response = await fetch(`${apiUrl}/user/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                
                if (data.code === 200 && data.token) {
                    document.getElementById('token').value = data.token;
                    updateLoginStatus();
                    showResult(resultEl, '登录成功！\n\n完整响应:\n' + JSON.stringify(data, null, 2), 'success');
                } else {
                    showResult(resultEl, '登录失败: ' + (data.msg || '未知错误') + '\n\n' + JSON.stringify(data, null, 2), 'error');
                }
            } catch (error) {
                showResult(resultEl, '请求失败: ' + error.message, 'error');
            }
        }

        // 清除Token
        function clearToken() {
            document.getElementById('token').value = '';
            updateLoginStatus();
            alert('Token已清除，现在处于未登录状态');
        }

        // 测试文章列表
        async function testArticleList(withToken) {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const token = document.getElementById('token').value.trim();
            const resultEl = document.getElementById('articleResult');

            resultEl.style.display = 'block';
            resultEl.innerHTML = '<pre><span class="info">正在查询文章列表...</span></pre>';

            try {
                const headers = {
                    'Content-Type': 'application/json'
                };

                if (withToken && token) {
                    headers['Authorization'] = 'Bearer ' + token;
                }

                const response = await fetch(`${apiUrl}/article/selectArticleAll?page=1&page_size=20`, {
                    method: 'GET',
                    headers: headers
                });

                const data = await response.json();
                
                let resultText = `=== ${withToken ? '已登录' : '未登录'}用户查询结果 ===\n\n`;
                resultText += `响应码: ${data.code}\n`;
                resultText += `消息: ${data.msg}\n`;
                
                if (data.data && data.data.list) {
                    resultText += `文章总数: ${data.data.pagination.total}\n`;
                    resultText += `当前页: ${data.data.pagination.current}\n`;
                    resultText += `返回数量: ${data.data.list.length}\n\n`;
                    
                    resultText += '文章列表:\n';
                    data.data.list.forEach((article, index) => {
                        resultText += `${index + 1}. [${article.id}] ${article.title}\n`;
                        resultText += `   可见性: ${article.visibility || '未设置'}\n`;
                        resultText += `   状态: ${article.status === 1 ? '已发布' : '草稿'}\n`;
                        resultText += `   作者ID: ${article.author_id}\n\n`;
                    });
                }
                
                resultText += '\n完整响应:\n' + JSON.stringify(data, null, 2);
                
                showResult(resultEl, resultText, data.code === 200 ? 'success' : 'error');
            } catch (error) {
                showResult(resultEl, '请求失败: ' + error.message, 'error');
            }
        }

        // 测试文章详情
        async function testArticleDetail(withToken) {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const token = document.getElementById('token').value.trim();
            const articleId = document.getElementById('articleId').value.trim();
            const resultEl = document.getElementById('detailResult');

            if (!articleId) {
                showResult(resultEl, '请输入文章ID', 'error');
                return;
            }

            resultEl.style.display = 'block';
            resultEl.innerHTML = '<pre><span class="info">正在查询文章详情...</span></pre>';

            try {
                const headers = {
                    'Content-Type': 'application/json'
                };

                if (withToken && token) {
                    headers['Authorization'] = 'Bearer ' + token;
                }

                const response = await fetch(`${apiUrl}/article/selectArticleById?id=${articleId}`, {
                    method: 'GET',
                    headers: headers
                });

                const data = await response.json();
                
                let resultText = `=== ${withToken ? '已登录' : '未登录'}用户查询结果 ===\n\n`;
                resultText += `响应码: ${data.code}\n`;
                resultText += `消息: ${data.msg}\n\n`;
                
                if (data.data) {
                    resultText += `文章ID: ${data.data.id}\n`;
                    resultText += `标题: ${data.data.title}\n`;
                    resultText += `可见性: ${data.data.visibility || '未设置'}\n`;
                    resultText += `作者ID: ${data.data.author_id}\n`;
                    resultText += `状态: ${data.data.status}\n\n`;
                }
                
                resultText += '完整响应:\n' + JSON.stringify(data, null, 2);
                
                showResult(resultEl, resultText, data.code === 200 ? 'success' : 'error');
            } catch (error) {
                showResult(resultEl, '请求失败: ' + error.message, 'error');
            }
        }

        // 显示结果
        function showResult(element, text, type) {
            const className = type === 'success' ? 'success' : (type === 'error' ? 'error' : 'info');
            element.style.display = 'block';
            element.innerHTML = `<pre><span class="${className}">${text}</span></pre>`;
        }

        // 页面加载时更新状态
        updateLoginStatus();
    </script>
</body>
</html>

