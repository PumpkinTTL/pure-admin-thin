# 邮件记录模块 - 文件规划

## 📊 数据库表结构

### 1. bl_email_records (邮件记录主表)

- **用途**: 存储邮件发送的主要信息和统计数据
- **关键字段**:
  - `id`: 主键
  - `notice_id`: 关联公告ID(可为空)
  - `sender_id`: 发送者ID
  - `title`: 邮件标题
  - `content`: 邮件内容
  - `receiver_type`: 接收方式(1-全部用户, 2-指定用户, 3-单个用户, 4-指定邮箱)
  - `total_count`: 总发送数量
  - `success_count`: 成功数量
  - `failed_count`: 失败数量
  - `send_status`: 发送状态(0-待发送, 1-发送中, 2-发送完成, 3-部分失败, 4-全部失败)
  - `send_time`: 发送时间
  - `deleted_at`: 软删除时间

### 2. bl_email_receivers (邮件接收者详情表)

- **用途**: 存储每个接收者的详细发送情况
- **关键字段**:
  - `id`: 主键
  - `email_record_id`: 关联邮件记录ID
  - `receiver_type`: 接收者类型(1-系统用户, 2-外部邮箱)
  - `user_id`: 用户ID
  - `email`: 邮箱地址
  - `send_status`: 发送状态(0-待发送, 1-成功, 2-失败)
  - `error_message`: 错误信息
  - `read_status`: 阅读状态
  - `read_time`: 阅读时间

---

## 🗂️ 后端文件结构

### 📂 src/admin/m-service-server/

#### 1. 模型层 (Model)

**路径**: `app/model/`

##### 文件: `EmailRecord.php`

```
app/model/EmailRecord.php
```

- **功能**: 邮件记录主表模型
- **关联关系**:
  - hasMany -> EmailReceiver (一对多)
  - belongsTo -> Notice (多对一,可选)
  - belongsTo -> User (发送者)

##### 文件: `EmailReceiver.php`

```
app/model/EmailReceiver.php
```

- **功能**: 邮件接收者详情模型
- **关联关系**:
  - belongsTo -> EmailRecord (多对一)
  - belongsTo -> User (多对一,可选)

---

#### 2. 服务层 (Service)

**路径**: `app/service/`

##### 文件: `EmailRecordService.php`

```
app/service/EmailRecordService.php
```

- **功能**: 邮件记录业务逻辑
- **主要方法**:
  - `getList($params)`: 获取邮件记录列表(分页、搜索、筛选)
  - `getDetail($id)`: 获取邮件记录详情(包含接收者列表)
  - `createRecord($data)`: 创建邮件记录
  - `sendEmail($recordId)`: 执行邮件发送
  - `batchSendEmail($data)`: 批量发送邮件
  - `deleteRecord($id)`: 软删除邮件记录
  - `getStatistics()`: 获取邮件发送统计数据
  - `resendFailed($recordId)`: 重新发送失败的邮件

##### 文件: `EmailSendService.php`

```
app/service/EmailSendService.php
```

- **功能**: 邮件发送核心服务
- **主要方法**:
  - `sendToUser($userId, $title, $content)`: 发送给单个用户
  - `sendToEmail($email, $title, $content)`: 发送到指定邮箱
  - `sendBatch($emails, $title, $content)`: 批量发送
  - `getEmailTemplate($type)`: 获取邮件模板
  - `parseTemplate($template, $data)`: 解析邮件模板

---

#### 3. 控制器层 (Controller)

**路径**: `app/controller/api/v1/`

##### 文件: `EmailRecordController.php`

```
app/controller/api/v1/EmailRecordController.php
```

- **功能**: 邮件记录API接口
- **路由前缀**: `/api/v1/email-record`
- **接口列表**:
  - `GET /list`: 获取邮件记录列表
  - `GET /detail/:id`: 获取邮件记录详情
  - `POST /send`: 发送邮件(创建记录并发送)
  - `POST /resend/:id`: 重新发送失败的邮件
  - `DELETE /delete/:id`: 删除邮件记录
  - `POST /batch-delete`: 批量删除
  - `GET /statistics`: 获取统计数据
  - `GET /receivers/:id`: 获取接收者列表

---

#### 4. 验证器 (Validate)

**路径**: `app/validate/`

##### 文件: `EmailRecordValidate.php`

```
app/validate/EmailRecordValidate.php
```

- **功能**: 邮件发送参数验证
- **验证规则**:
  - `send`: 发送邮件验证
  - `list`: 列表查询验证
  - `delete`: 删除验证

---

#### 5. 路由配置

**路径**: `route/`

##### 文件: `api.php` (修改现有文件)

```
route/api.php
```

- **添加路由组**: 邮件记录相关路由

---

## 🎨 前端文件结构

### 📂 src/

#### 1. API接口层

**路径**: `api/`

##### 文件: `emailRecord.ts`

```
src/api/emailRecord.ts
```

- **功能**: 邮件记录API接口定义
- **导出内容**:
  - 接口函数: `getEmailRecordList`, `getEmailRecordDetail`, `sendEmail`, `resendEmail`, `deleteEmailRecord`, `batchDeleteEmailRecord`, `getEmailStatistics`, `getEmailReceivers`
  - 类型定义: `EmailRecordParams`, `EmailRecordData`, `EmailReceiverData`, `EmailSendData`, `EmailStatistics`
  - 常量: `RECEIVER_TYPES`, `SEND_STATUS`, `READ_STATUS`

---

#### 2. 视图组件层

**路径**: `views/system/`

##### 文件: `notice.vue` (修改现有文件)

```
src/views/system/notice.vue
```

- **修改内容**:
  - 添加Tab切换(公告管理 / 邮件记录)
  - 集成邮件记录表格组件
  - 共享邮件发送弹窗

##### 新增组件: `components/EmailRecordTable.vue`

```
src/views/system/components/EmailRecordTable.vue
```

- **功能**: 邮件记录表格组件
- **主要功能**:
  - 邮件记录列表展示
  - 搜索筛选(标题、发送者、状态、时间范围)
  - 查看详情(接收者列表)
  - 重新发送失败邮件
  - 删除记录
  - 统计数据展示

##### 新增组件: `components/EmailRecordDetail.vue`

```
src/views/system/components/EmailRecordDetail.vue
```

- **功能**: 邮件记录详情弹窗
- **显示内容**:
  - 邮件基本信息
  - 发送统计
  - 接收者列表(表格)
  - 失败原因
  - 操作按钮(重新发送失败项)

---

#### 3. 类型定义

**路径**: `types/`

##### 文件: `emailRecord.d.ts`

```
src/types/emailRecord.d.ts
```

- **功能**: TypeScript类型定义
- **导出类型**:
  - `EmailRecord`: 邮件记录
  - `EmailReceiver`: 邮件接收者
  - `EmailSendParams`: 发送参数
  - `EmailStatistics`: 统计数据

---

## 📋 文件创建清单

### 后端文件 (7个)

- [ ] `src/admin/m-service-server/app/model/EmailRecord.php`
- [ ] `src/admin/m-service-server/app/model/EmailReceiver.php`
- [ ] `src/admin/m-service-server/app/service/EmailRecordService.php`
- [ ] `src/admin/m-service-server/app/service/EmailSendService.php`
- [ ] `src/admin/m-service-server/app/controller/api/v1/EmailRecordController.php`
- [ ] `src/admin/m-service-server/app/validate/EmailRecordValidate.php`
- [ ] `src/admin/m-service-server/route/api.php` (修改)

### 前端文件 (5个)

- [ ] `src/api/emailRecord.ts`
- [ ] `src/views/system/components/EmailRecordTable.vue`
- [ ] `src/views/system/components/EmailRecordDetail.vue`
- [ ] `src/views/system/notice.vue` (修改 - 添加Tab切换)
- [ ] `src/types/emailRecord.d.ts`

---

## 🔄 数据流程

### 发送邮件流程

```
前端 notice.vue (发送邮件弹窗)
  ↓ POST /api/v1/email-record/send
EmailRecordController::send()
  ↓
EmailRecordService::createRecord() (创建记录)
  ↓
EmailRecordService::sendEmail() (执行发送)
  ↓
EmailSendService::sendBatch() (批量发送)
  ↓
EmailUtil::sendMail() (实际发送)
  ↓
更新 EmailRecord 和 EmailReceiver 状态
  ↓
返回发送结果
```

### 查看记录流程

```
前端 EmailRecordTable.vue
  ↓ GET /api/v1/email-record/list
EmailRecordController::list()
  ↓
EmailRecordService::getList()
  ↓
返回邮件记录列表(带统计)
```

### 查看详情流程

```
前端 EmailRecordDetail.vue
  ↓ GET /api/v1/email-record/detail/:id
EmailRecordController::detail()
  ↓
EmailRecordService::getDetail()
  ↓
返回邮件详情 + 接收者列表
```

---

## 🎯 核心功能点

### 1. 邮件发送

- 支持4种接收方式(全部用户、指定用户、单个用户、指定邮箱)
- 异步发送(避免阻塞)
- 发送进度跟踪
- 失败重试机制

### 2. 记录管理

- 列表展示(分页、搜索、筛选)
- 详情查看(接收者明细)
- 软删除
- 批量操作

### 3. 统计分析

- 总发送数量
- 成功/失败率
- 时间趋势图
- 接收者分析

### 4. 重发机制

- 重发失败的邮件
- 重发指定接收者
- 重发整个记录

---

## 🚀 开发顺序建议

1. **数据库** → 执行SQL脚本创建表
2. **后端Model** → EmailRecord.php, EmailReceiver.php
3. **后端Service** → EmailSendService.php, EmailRecordService.php
4. **后端Controller** → EmailRecordController.php
5. **后端Validate** → EmailRecordValidate.php
6. **后端Route** → 添加路由
7. **前端API** → emailRecord.ts
8. **前端组件** → EmailRecordTable.vue, EmailRecordDetail.vue
9. **前端集成** → 修改notice.vue添加Tab切换
10. **测试** → 功能测试、接口测试

---

## 📝 注意事项

1. **邮件发送采用异步方式**,避免阻塞用户操作
2. **记录详细的发送日志**,便于排查问题
3. **软删除机制**,保留历史记录
4. **权限控制**,只有管理员可以查看所有记录
5. **性能优化**,大量邮件发送时使用队列
6. **错误处理**,记录详细的失败原因
7. **邮件模板**,支持HTML格式美化邮件
8. **发送限制**,防止滥用(频率限制、数量限制)
