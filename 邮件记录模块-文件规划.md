# é‚®ä»¶è®°å½•æ¨¡å— - æ–‡ä»¶è§„åˆ’

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„

### 1. bl_email_records (é‚®ä»¶è®°å½•ä¸»è¡¨)

- **ç”¨é€”**: å­˜å‚¨é‚®ä»¶å‘é€çš„ä¸»è¦ä¿¡æ¯å’Œç»Ÿè®¡æ•°æ®
- **å…³é”®å­—æ®µ**:
  - `id`: ä¸»é”®
  - `notice_id`: å…³è”å…¬å‘ŠID(å¯ä¸ºç©º)
  - `sender_id`: å‘é€è€…ID
  - `title`: é‚®ä»¶æ ‡é¢˜
  - `content`: é‚®ä»¶å†…å®¹
  - `receiver_type`: æ¥æ”¶æ–¹å¼(1-å…¨éƒ¨ç”¨æˆ·, 2-æŒ‡å®šç”¨æˆ·, 3-å•ä¸ªç”¨æˆ·, 4-æŒ‡å®šé‚®ç®±)
  - `total_count`: æ€»å‘é€æ•°é‡
  - `success_count`: æˆåŠŸæ•°é‡
  - `failed_count`: å¤±è´¥æ•°é‡
  - `send_status`: å‘é€çŠ¶æ€(0-å¾…å‘é€, 1-å‘é€ä¸­, 2-å‘é€å®Œæˆ, 3-éƒ¨åˆ†å¤±è´¥, 4-å…¨éƒ¨å¤±è´¥)
  - `send_time`: å‘é€æ—¶é—´
  - `deleted_at`: è½¯åˆ é™¤æ—¶é—´

### 2. bl_email_receivers (é‚®ä»¶æ¥æ”¶è€…è¯¦æƒ…è¡¨)

- **ç”¨é€”**: å­˜å‚¨æ¯ä¸ªæ¥æ”¶è€…çš„è¯¦ç»†å‘é€æƒ…å†µ
- **å…³é”®å­—æ®µ**:
  - `id`: ä¸»é”®
  - `email_record_id`: å…³è”é‚®ä»¶è®°å½•ID
  - `receiver_type`: æ¥æ”¶è€…ç±»å‹(1-ç³»ç»Ÿç”¨æˆ·, 2-å¤–éƒ¨é‚®ç®±)
  - `user_id`: ç”¨æˆ·ID
  - `email`: é‚®ç®±åœ°å€
  - `send_status`: å‘é€çŠ¶æ€(0-å¾…å‘é€, 1-æˆåŠŸ, 2-å¤±è´¥)
  - `error_message`: é”™è¯¯ä¿¡æ¯
  - `read_status`: é˜…è¯»çŠ¶æ€
  - `read_time`: é˜…è¯»æ—¶é—´

---

## ğŸ—‚ï¸ åç«¯æ–‡ä»¶ç»“æ„

### ğŸ“‚ src/admin/m-service-server/

#### 1. æ¨¡å‹å±‚ (Model)

**è·¯å¾„**: `app/model/`

##### æ–‡ä»¶: `EmailRecord.php`

```
app/model/EmailRecord.php
```

- **åŠŸèƒ½**: é‚®ä»¶è®°å½•ä¸»è¡¨æ¨¡å‹
- **å…³è”å…³ç³»**:
  - hasMany -> EmailReceiver (ä¸€å¯¹å¤š)
  - belongsTo -> Notice (å¤šå¯¹ä¸€,å¯é€‰)
  - belongsTo -> User (å‘é€è€…)

##### æ–‡ä»¶: `EmailReceiver.php`

```
app/model/EmailReceiver.php
```

- **åŠŸèƒ½**: é‚®ä»¶æ¥æ”¶è€…è¯¦æƒ…æ¨¡å‹
- **å…³è”å…³ç³»**:
  - belongsTo -> EmailRecord (å¤šå¯¹ä¸€)
  - belongsTo -> User (å¤šå¯¹ä¸€,å¯é€‰)

---

#### 2. æœåŠ¡å±‚ (Service)

**è·¯å¾„**: `app/service/`

##### æ–‡ä»¶: `EmailRecordService.php`

```
app/service/EmailRecordService.php
```

- **åŠŸèƒ½**: é‚®ä»¶è®°å½•ä¸šåŠ¡é€»è¾‘
- **ä¸»è¦æ–¹æ³•**:
  - `getList($params)`: è·å–é‚®ä»¶è®°å½•åˆ—è¡¨(åˆ†é¡µã€æœç´¢ã€ç­›é€‰)
  - `getDetail($id)`: è·å–é‚®ä»¶è®°å½•è¯¦æƒ…(åŒ…å«æ¥æ”¶è€…åˆ—è¡¨)
  - `createRecord($data)`: åˆ›å»ºé‚®ä»¶è®°å½•
  - `sendEmail($recordId)`: æ‰§è¡Œé‚®ä»¶å‘é€
  - `batchSendEmail($data)`: æ‰¹é‡å‘é€é‚®ä»¶
  - `deleteRecord($id)`: è½¯åˆ é™¤é‚®ä»¶è®°å½•
  - `getStatistics()`: è·å–é‚®ä»¶å‘é€ç»Ÿè®¡æ•°æ®
  - `resendFailed($recordId)`: é‡æ–°å‘é€å¤±è´¥çš„é‚®ä»¶

##### æ–‡ä»¶: `EmailSendService.php`

```
app/service/EmailSendService.php
```

- **åŠŸèƒ½**: é‚®ä»¶å‘é€æ ¸å¿ƒæœåŠ¡
- **ä¸»è¦æ–¹æ³•**:
  - `sendToUser($userId, $title, $content)`: å‘é€ç»™å•ä¸ªç”¨æˆ·
  - `sendToEmail($email, $title, $content)`: å‘é€åˆ°æŒ‡å®šé‚®ç®±
  - `sendBatch($emails, $title, $content)`: æ‰¹é‡å‘é€
  - `getEmailTemplate($type)`: è·å–é‚®ä»¶æ¨¡æ¿
  - `parseTemplate($template, $data)`: è§£æé‚®ä»¶æ¨¡æ¿

---

#### 3. æ§åˆ¶å™¨å±‚ (Controller)

**è·¯å¾„**: `app/controller/api/v1/`

##### æ–‡ä»¶: `EmailRecordController.php`

```
app/controller/api/v1/EmailRecordController.php
```

- **åŠŸèƒ½**: é‚®ä»¶è®°å½•APIæ¥å£
- **è·¯ç”±å‰ç¼€**: `/api/v1/email-record`
- **æ¥å£åˆ—è¡¨**:
  - `GET /list`: è·å–é‚®ä»¶è®°å½•åˆ—è¡¨
  - `GET /detail/:id`: è·å–é‚®ä»¶è®°å½•è¯¦æƒ…
  - `POST /send`: å‘é€é‚®ä»¶(åˆ›å»ºè®°å½•å¹¶å‘é€)
  - `POST /resend/:id`: é‡æ–°å‘é€å¤±è´¥çš„é‚®ä»¶
  - `DELETE /delete/:id`: åˆ é™¤é‚®ä»¶è®°å½•
  - `POST /batch-delete`: æ‰¹é‡åˆ é™¤
  - `GET /statistics`: è·å–ç»Ÿè®¡æ•°æ®
  - `GET /receivers/:id`: è·å–æ¥æ”¶è€…åˆ—è¡¨

---

#### 4. éªŒè¯å™¨ (Validate)

**è·¯å¾„**: `app/validate/`

##### æ–‡ä»¶: `EmailRecordValidate.php`

```
app/validate/EmailRecordValidate.php
```

- **åŠŸèƒ½**: é‚®ä»¶å‘é€å‚æ•°éªŒè¯
- **éªŒè¯è§„åˆ™**:
  - `send`: å‘é€é‚®ä»¶éªŒè¯
  - `list`: åˆ—è¡¨æŸ¥è¯¢éªŒè¯
  - `delete`: åˆ é™¤éªŒè¯

---

#### 5. è·¯ç”±é…ç½®

**è·¯å¾„**: `route/`

##### æ–‡ä»¶: `api.php` (ä¿®æ”¹ç°æœ‰æ–‡ä»¶)

```
route/api.php
```

- **æ·»åŠ è·¯ç”±ç»„**: é‚®ä»¶è®°å½•ç›¸å…³è·¯ç”±

---

## ğŸ¨ å‰ç«¯æ–‡ä»¶ç»“æ„

### ğŸ“‚ src/

#### 1. APIæ¥å£å±‚

**è·¯å¾„**: `api/`

##### æ–‡ä»¶: `emailRecord.ts`

```
src/api/emailRecord.ts
```

- **åŠŸèƒ½**: é‚®ä»¶è®°å½•APIæ¥å£å®šä¹‰
- **å¯¼å‡ºå†…å®¹**:
  - æ¥å£å‡½æ•°: `getEmailRecordList`, `getEmailRecordDetail`, `sendEmail`, `resendEmail`, `deleteEmailRecord`, `batchDeleteEmailRecord`, `getEmailStatistics`, `getEmailReceivers`
  - ç±»å‹å®šä¹‰: `EmailRecordParams`, `EmailRecordData`, `EmailReceiverData`, `EmailSendData`, `EmailStatistics`
  - å¸¸é‡: `RECEIVER_TYPES`, `SEND_STATUS`, `READ_STATUS`

---

#### 2. è§†å›¾ç»„ä»¶å±‚

**è·¯å¾„**: `views/system/`

##### æ–‡ä»¶: `notice.vue` (ä¿®æ”¹ç°æœ‰æ–‡ä»¶)

```
src/views/system/notice.vue
```

- **ä¿®æ”¹å†…å®¹**:
  - æ·»åŠ Tabåˆ‡æ¢(å…¬å‘Šç®¡ç† / é‚®ä»¶è®°å½•)
  - é›†æˆé‚®ä»¶è®°å½•è¡¨æ ¼ç»„ä»¶
  - å…±äº«é‚®ä»¶å‘é€å¼¹çª—

##### æ–°å¢ç»„ä»¶: `components/EmailRecordTable.vue`

```
src/views/system/components/EmailRecordTable.vue
```

- **åŠŸèƒ½**: é‚®ä»¶è®°å½•è¡¨æ ¼ç»„ä»¶
- **ä¸»è¦åŠŸèƒ½**:
  - é‚®ä»¶è®°å½•åˆ—è¡¨å±•ç¤º
  - æœç´¢ç­›é€‰(æ ‡é¢˜ã€å‘é€è€…ã€çŠ¶æ€ã€æ—¶é—´èŒƒå›´)
  - æŸ¥çœ‹è¯¦æƒ…(æ¥æ”¶è€…åˆ—è¡¨)
  - é‡æ–°å‘é€å¤±è´¥é‚®ä»¶
  - åˆ é™¤è®°å½•
  - ç»Ÿè®¡æ•°æ®å±•ç¤º

##### æ–°å¢ç»„ä»¶: `components/EmailRecordDetail.vue`

```
src/views/system/components/EmailRecordDetail.vue
```

- **åŠŸèƒ½**: é‚®ä»¶è®°å½•è¯¦æƒ…å¼¹çª—
- **æ˜¾ç¤ºå†…å®¹**:
  - é‚®ä»¶åŸºæœ¬ä¿¡æ¯
  - å‘é€ç»Ÿè®¡
  - æ¥æ”¶è€…åˆ—è¡¨(è¡¨æ ¼)
  - å¤±è´¥åŸå› 
  - æ“ä½œæŒ‰é’®(é‡æ–°å‘é€å¤±è´¥é¡¹)

---

#### 3. ç±»å‹å®šä¹‰

**è·¯å¾„**: `types/`

##### æ–‡ä»¶: `emailRecord.d.ts`

```
src/types/emailRecord.d.ts
```

- **åŠŸèƒ½**: TypeScriptç±»å‹å®šä¹‰
- **å¯¼å‡ºç±»å‹**:
  - `EmailRecord`: é‚®ä»¶è®°å½•
  - `EmailReceiver`: é‚®ä»¶æ¥æ”¶è€…
  - `EmailSendParams`: å‘é€å‚æ•°
  - `EmailStatistics`: ç»Ÿè®¡æ•°æ®

---

## ğŸ“‹ æ–‡ä»¶åˆ›å»ºæ¸…å•

### åç«¯æ–‡ä»¶ (7ä¸ª)

- [ ] `src/admin/m-service-server/app/model/EmailRecord.php`
- [ ] `src/admin/m-service-server/app/model/EmailReceiver.php`
- [ ] `src/admin/m-service-server/app/service/EmailRecordService.php`
- [ ] `src/admin/m-service-server/app/service/EmailSendService.php`
- [ ] `src/admin/m-service-server/app/controller/api/v1/EmailRecordController.php`
- [ ] `src/admin/m-service-server/app/validate/EmailRecordValidate.php`
- [ ] `src/admin/m-service-server/route/api.php` (ä¿®æ”¹)

### å‰ç«¯æ–‡ä»¶ (5ä¸ª)

- [ ] `src/api/emailRecord.ts`
- [ ] `src/views/system/components/EmailRecordTable.vue`
- [ ] `src/views/system/components/EmailRecordDetail.vue`
- [ ] `src/views/system/notice.vue` (ä¿®æ”¹ - æ·»åŠ Tabåˆ‡æ¢)
- [ ] `src/types/emailRecord.d.ts`

---

## ğŸ”„ æ•°æ®æµç¨‹

### å‘é€é‚®ä»¶æµç¨‹

```
å‰ç«¯ notice.vue (å‘é€é‚®ä»¶å¼¹çª—)
  â†“ POST /api/v1/email-record/send
EmailRecordController::send()
  â†“
EmailRecordService::createRecord() (åˆ›å»ºè®°å½•)
  â†“
EmailRecordService::sendEmail() (æ‰§è¡Œå‘é€)
  â†“
EmailSendService::sendBatch() (æ‰¹é‡å‘é€)
  â†“
EmailUtil::sendMail() (å®é™…å‘é€)
  â†“
æ›´æ–° EmailRecord å’Œ EmailReceiver çŠ¶æ€
  â†“
è¿”å›å‘é€ç»“æœ
```

### æŸ¥çœ‹è®°å½•æµç¨‹

```
å‰ç«¯ EmailRecordTable.vue
  â†“ GET /api/v1/email-record/list
EmailRecordController::list()
  â†“
EmailRecordService::getList()
  â†“
è¿”å›é‚®ä»¶è®°å½•åˆ—è¡¨(å¸¦ç»Ÿè®¡)
```

### æŸ¥çœ‹è¯¦æƒ…æµç¨‹

```
å‰ç«¯ EmailRecordDetail.vue
  â†“ GET /api/v1/email-record/detail/:id
EmailRecordController::detail()
  â†“
EmailRecordService::getDetail()
  â†“
è¿”å›é‚®ä»¶è¯¦æƒ… + æ¥æ”¶è€…åˆ—è¡¨
```

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½ç‚¹

### 1. é‚®ä»¶å‘é€

- æ”¯æŒ4ç§æ¥æ”¶æ–¹å¼(å…¨éƒ¨ç”¨æˆ·ã€æŒ‡å®šç”¨æˆ·ã€å•ä¸ªç”¨æˆ·ã€æŒ‡å®šé‚®ç®±)
- å¼‚æ­¥å‘é€(é¿å…é˜»å¡)
- å‘é€è¿›åº¦è·Ÿè¸ª
- å¤±è´¥é‡è¯•æœºåˆ¶

### 2. è®°å½•ç®¡ç†

- åˆ—è¡¨å±•ç¤º(åˆ†é¡µã€æœç´¢ã€ç­›é€‰)
- è¯¦æƒ…æŸ¥çœ‹(æ¥æ”¶è€…æ˜ç»†)
- è½¯åˆ é™¤
- æ‰¹é‡æ“ä½œ

### 3. ç»Ÿè®¡åˆ†æ

- æ€»å‘é€æ•°é‡
- æˆåŠŸ/å¤±è´¥ç‡
- æ—¶é—´è¶‹åŠ¿å›¾
- æ¥æ”¶è€…åˆ†æ

### 4. é‡å‘æœºåˆ¶

- é‡å‘å¤±è´¥çš„é‚®ä»¶
- é‡å‘æŒ‡å®šæ¥æ”¶è€…
- é‡å‘æ•´ä¸ªè®°å½•

---

## ğŸš€ å¼€å‘é¡ºåºå»ºè®®

1. **æ•°æ®åº“** â†’ æ‰§è¡ŒSQLè„šæœ¬åˆ›å»ºè¡¨
2. **åç«¯Model** â†’ EmailRecord.php, EmailReceiver.php
3. **åç«¯Service** â†’ EmailSendService.php, EmailRecordService.php
4. **åç«¯Controller** â†’ EmailRecordController.php
5. **åç«¯Validate** â†’ EmailRecordValidate.php
6. **åç«¯Route** â†’ æ·»åŠ è·¯ç”±
7. **å‰ç«¯API** â†’ emailRecord.ts
8. **å‰ç«¯ç»„ä»¶** â†’ EmailRecordTable.vue, EmailRecordDetail.vue
9. **å‰ç«¯é›†æˆ** â†’ ä¿®æ”¹notice.vueæ·»åŠ Tabåˆ‡æ¢
10. **æµ‹è¯•** â†’ åŠŸèƒ½æµ‹è¯•ã€æ¥å£æµ‹è¯•

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **é‚®ä»¶å‘é€é‡‡ç”¨å¼‚æ­¥æ–¹å¼**,é¿å…é˜»å¡ç”¨æˆ·æ“ä½œ
2. **è®°å½•è¯¦ç»†çš„å‘é€æ—¥å¿—**,ä¾¿äºæ’æŸ¥é—®é¢˜
3. **è½¯åˆ é™¤æœºåˆ¶**,ä¿ç•™å†å²è®°å½•
4. **æƒé™æ§åˆ¶**,åªæœ‰ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰è®°å½•
5. **æ€§èƒ½ä¼˜åŒ–**,å¤§é‡é‚®ä»¶å‘é€æ—¶ä½¿ç”¨é˜Ÿåˆ—
6. **é”™è¯¯å¤„ç†**,è®°å½•è¯¦ç»†çš„å¤±è´¥åŸå› 
7. **é‚®ä»¶æ¨¡æ¿**,æ”¯æŒHTMLæ ¼å¼ç¾åŒ–é‚®ä»¶
8. **å‘é€é™åˆ¶**,é˜²æ­¢æ»¥ç”¨(é¢‘ç‡é™åˆ¶ã€æ•°é‡é™åˆ¶)
